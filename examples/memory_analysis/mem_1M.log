SQLite3 Sharding Memory Footprint Analysis
==========================================
=== Baseline (before initialization) ===
Allocated memory: 0 MB
Total allocations: 0 MB
System memory: 6 MB
GC cycles: 0

Testing Mode 0: Single Database (1 DB, 4096 tables)
Initialized: 1 DB with 4096 tables
Databases: 1, Tables per DB: 4096
Initialization time: 8.545159671s
=== Mode 0 - After initialization ===
Allocated memory: 2 MB
Total allocations: 2 MB
System memory: 6 MB
GC cycles: 0

Inserting 1000000 test hashes into Mode 0...
  Inserted 100000/1000000 hashes (10.0%, 100000 successful)...
  Inserted 200000/1000000 hashes (20.0%, 200000 successful)...
  Inserted 300000/1000000 hashes (30.0%, 300000 successful)...
  Inserted 400000/1000000 hashes (40.0%, 400000 successful)...
  Inserted 500000/1000000 hashes (50.0%, 500000 successful)...
  Inserted 600000/1000000 hashes (60.0%, 600000 successful)...
  Inserted 700000/1000000 hashes (70.0%, 700000 successful)...
  Inserted 800000/1000000 hashes (80.0%, 800000 successful)...
  Inserted 900000/1000000 hashes (90.0%, 900000 successful)...
  Inserted 1000000/1000000 hashes (100.0%, 1000000 successful)...
Completed inserting 1000000 hashes in 2.998730855s (333474 hashes/sec, 1000000 successful)
=== Mode 0 - After inserting test hashes ===
Allocated memory: 1 MB
Total allocations: 407 MB
System memory: 11 MB
GC cycles: 118

=== Mode 0 - After GC ===
Allocated memory: 0 MB
Total allocations: 407 MB
System memory: 11 MB
GC cycles: 119


Testing Mode 2: Hybrid Approach (16 DBs, 256 tables each)
Initialized: 16 DBs with 256 tables each
Databases: 16, Tables per DB: 256
Initialization time: 2.418768084s
=== Mode 2 - After initialization ===
Allocated memory: 2 MB
Total allocations: 409 MB
System memory: 11 MB
GC cycles: 119

Inserting 1000000 test hashes into Mode 2...
  Inserted 100000/1000000 hashes (10.0%, 100000 successful)...
  Inserted 200000/1000000 hashes (20.0%, 200000 successful)...
  Inserted 300000/1000000 hashes (30.0%, 300000 successful)...
  Inserted 400000/1000000 hashes (40.0%, 400000 successful)...
  Inserted 500000/1000000 hashes (50.0%, 500000 successful)...
  Inserted 600000/1000000 hashes (60.0%, 600000 successful)...
  Inserted 700000/1000000 hashes (70.0%, 700000 successful)...
  Inserted 800000/1000000 hashes (80.0%, 800000 successful)...
  Inserted 900000/1000000 hashes (90.0%, 900000 successful)...
  Inserted 1000000/1000000 hashes (100.0%, 1000000 successful)...
Completed inserting 1000000 hashes in 3.012618446s (331937 hashes/sec, 1000000 successful)
=== Mode 2 - After inserting test hashes ===
Allocated memory: 1 MB
Total allocations: 814 MB
System memory: 11 MB
GC cycles: 239

=== Mode 2 - After GC ===
Allocated memory: 0 MB
Total allocations: 814 MB
System memory: 11 MB
GC cycles: 240

Cache configuration: 2000 pages (7 MB per DB, 112 MB total)
Estimated total memory: 129 MB

Testing Mode 3: Balanced Approach (64 DBs, 64 tables each)
Initialized: 64 DBs with 64 tables each
Databases: 64, Tables per DB: 64
Initialization time: 3.054980174s
=== Mode 3 - After initialization ===
Allocated memory: 2 MB
Total allocations: 816 MB
System memory: 11 MB
GC cycles: 240

Inserting 1000000 test hashes into Mode 3...
  Inserted 100000/1000000 hashes (10.0%, 100000 successful)...
  Inserted 200000/1000000 hashes (20.0%, 200000 successful)...
  Inserted 300000/1000000 hashes (30.0%, 300000 successful)...
  Inserted 400000/1000000 hashes (40.0%, 400000 successful)...
  Inserted 500000/1000000 hashes (50.0%, 500000 successful)...
  Inserted 600000/1000000 hashes (60.0%, 600000 successful)...
  Inserted 700000/1000000 hashes (70.0%, 700000 successful)...
  Inserted 800000/1000000 hashes (80.0%, 800000 successful)...
  Inserted 900000/1000000 hashes (90.0%, 900000 successful)...
  Inserted 1000000/1000000 hashes (100.0%, 1000000 successful)...
Completed inserting 1000000 hashes in 3.101505308s (322424 hashes/sec, 1000000 successful)
=== Mode 3 - After inserting test hashes ===
Allocated memory: 1 MB
Total allocations: 1221 MB
System memory: 12 MB
GC cycles: 369

=== Mode 3 - After GC ===
Allocated memory: 0 MB
Total allocations: 1221 MB
System memory: 12 MB
GC cycles: 370

Cache configuration: 1000 pages (3 MB per DB, 192 MB total)
Estimated total memory: 248 MB

=== MEMORY USAGE SUMMARY ===
Mode 0 (1 DB): Initialization time 8.545159671s
Mode 2 (16 DBs): Initialization time 2.418768084s
Mode 3 (64 DBs): Initialization time 3.054980174s

Observations:
• Mode 0 uses least memory (shared page cache, 400MB)
• Mode 2 uses adaptive cache (8MB per DB × 16 = 128MB total)
• Mode 3 uses adaptive cache (4MB per DB × 64 = 256MB total)
• Initialization time increases with more databases
• Adaptive cache sizing makes multi-DB modes practical

Recommendations:
• Use Mode 0 for most applications (best single-DB performance)
• Use Mode 2 for 16-way parallelism (good memory efficiency)
• Use Mode 3 for 64-way parallelism (moderate memory usage)
• Monitor memory usage in production environments
• Multi-DB modes now use adaptive cache sizing to prevent excessive RAM usage
